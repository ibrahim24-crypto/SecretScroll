rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    function isSuperAdmin() {
      return request.auth != null && 
             request.auth.token.email == 'ibrahimezzine09@gmail.com';
    }
  
    function getPermissions() {
      // This function now safely handles cases where a user might not be logged in.
      if (request.auth == null) {
        return {};
      }
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.permissions;
    }
    
    function hasPermission(permission) {
      return getPermissions()[permission] == true;
    }

    function isAdmin() {
      if (request.auth == null) {
        return false;
      }
      let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
      return userDoc.data.role == 'admin';
    }
  
    match /users/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow list: if isAdmin();
      allow create: if request.resource.data.uid == request.auth.uid;
      allow update: if isSuperAdmin() || (isAdmin() && hasPermission('manage_admins'));
      allow delete: if (isSuperAdmin() || (isAdmin() && hasPermission('delete_users'))) && request.auth.uid != userId;
    }

    match /userDisplayNames/{name} {
      allow read: if true;
      allow create: if request.auth != null && request.resource.data.uid == request.auth.uid;
    }

    match /posts/{postId} {
      // Allow public read only on approved posts. Admins can read any.
      allow read: if resource.data.status == 'approved' || isAdmin();
      
      allow create: if request.auth != null;

      allow update: if (
        // Any authenticated user can vote or update comment count on an approved post
        request.auth != null && resource.data.status == 'approved' &&
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['upvotes', 'downvotes', 'commentCount'])
      ) || (
        // Admins can manage posts (approve/reject/edit images)
        isAdmin() && request.resource.data.diff(resource.data).affectedKeys().hasAny(['status', 'images', 'hasPendingImages'])
      ) || (
        // The author can edit their own post content
        isOwner(resource.data.authorUid) &&
        request.resource.data.diff(resource.data).affectedKeys().subsetOf(['title', 'content', 'category', 'eventDate', 'customFields', 'images', 'hasPendingImages', 'updatedAt', 'isFlagged'])
      )
      || isSuperAdmin();

      allow delete: if isOwner(resource.data.authorUid) || isSuperAdmin() || (isAdmin() && hasPermission('delete_posts'));
    }
    
    match /votes/{voteId} {
      allow read, write: if isOwner(request.resource.data.userId);
    }

    match /comments/{commentId} {
      allow read: if true;
      allow create: if request.auth != null 
                    && request.resource.data.content != null 
                    && request.resource.data.content.size() > 0
                    && request.resource.data.content.size() < 500;
      allow delete: if isOwner(resource.data.userId) || isSuperAdmin() || (isAdmin() && hasPermission('delete_comments'));
    }

    match /settings/{document} {
      // Any authenticated user can READ settings (required for client-side checks)
      allow read: if request.auth != null;
      // Only specific admins can WRITE settings
      allow write: if (isSuperAdmin() || (isAdmin() && (
        (document == 'config' && hasPermission('manage_forbidden_words')) ||
        (document == 'protectedNames' && hasPermission('manage_protected_names'))
      )));
    }
  }
}
