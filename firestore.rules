rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    function isSuperAdmin() {
      return request.auth != null && 
             request.auth.token.email == 'ibrahimezzine09@gmail.com';
    }

    // This function should only be called after checking if the user is authenticated.
    function getPermissions() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.permissions;
    }
    
    function hasPermission(permission) {
      // It is now safe to call getPermissions() directly because isAdmin() gatekeeps it.
      return getPermissions()[permission] == true;
    }

    function isAdmin() {
      // IMPORTANT FIX: Check if the user document exists before trying to read its role.
      // This prevents errors on first login before the user document is created.
      return request.auth != null &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
  
    match /users/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow list: if isAdmin();
      allow create: if request.resource.data.uid == request.auth.uid;
      allow update: if isSuperAdmin() || (isAdmin() && hasPermission('manage_admins'));
      allow delete: if (isSuperAdmin() || (isAdmin() && hasPermission('delete_users'))) && request.auth.uid != userId;
    }

    match /userDisplayNames/{name} {
      allow read: if true;
      allow create: if request.auth != null && request.resource.data.uid == request.auth.uid;
    }

    match /posts/{postId} {
      // Public can read approved posts. Admins and authors can read their own posts.
      allow read: if resource.data.status == 'approved' || isAdmin() || isOwner(resource.data.authorUid);
      
      allow create: if request.auth != null;

      allow update: if (
        // Any authenticated user can vote or update comment count on an approved post
        request.auth != null && resource.data.status == 'approved' &&
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['upvotes', 'downvotes', 'commentCount'])
      ) || (
        // Admins can manage posts (approve/reject/edit images)
        isAdmin() && hasPermission('approve_pictures') &&
        request.resource.data.diff(resource.data).hasAny(['status', 'images', 'hasPendingImages', 'updatedAt'])
      ) || (
        // The author can edit their own post content
        isOwner(resource.data.authorUid) &&
        request.resource.data.diff(resource.data).subsetOf(['title', 'content', 'category', 'eventDate', 'customFields', 'images', 'hasPendingImages', 'updatedAt', 'isFlagged'])
      )
      || isSuperAdmin();

      allow delete: if isOwner(resource.data.authorUid) || isSuperAdmin() || (isAdmin() && hasPermission('delete_posts'));
    }
    
    match /votes/{voteId} {
      allow read, write: if isOwner(request.resource.data.userId);
    }

    match /comments/{commentId} {
      allow read: if true;
      allow create: if request.auth != null 
                    && request.resource.data.content != null 
                    && request.resource.data.content.size() > 0
                    && request.resource.data.content.size() < 500;
      allow delete: if isOwner(resource.data.userId) || isSuperAdmin() || (isAdmin() && hasPermission('delete_comments'));
    }

    match /settings/{document} {
      // Any authenticated user can READ settings (required for client-side checks)
      allow read: if request.auth != null;
      // Only specific admins can WRITE settings
      allow write: if isSuperAdmin() || (isAdmin() && (
        (document == 'config' && hasPermission('manage_forbidden_words')) ||
        (document == 'protectedNames' && hasPermission('manage_protected_names'))
      ));
    }
  }
}
