rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    function isSuperAdmin() {
      return request.auth != null &&
             request.auth.token.email == 'ibrahimezzine09@gmail.com';
    }

    function userDocExists() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function isAdmin() {
      return request.auth != null &&
             userDocExists() &&
             getUserData().role == 'admin';
    }

    function getPermissions() {
      return userDocExists() ? getUserData().permissions : {};
    }

    function hasPermission(permission) {
      // This is now safe because isAdmin() already checks for document existence.
      return isAdmin() && getPermissions()[permission] == true;
    }

    match /users/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow list: if isAdmin();
      allow create: if request.resource.data.uid == request.auth.uid;
      allow update: if isSuperAdmin() || (isAdmin() && hasPermission('manage_admins'));
      allow delete: if (isSuperAdmin() || (isAdmin() && hasPermission('delete_users'))) && request.auth.uid != userId;
    }

    match /userDisplayNames/{name} {
      allow read: if true;
      allow create: if request.auth != null && request.resource.data.uid == request.auth.uid;
    }

    match /posts/{postId} {
      // Public can read approved posts. Admins and authors can read their own posts.
      allow read: if resource.data.status == 'approved' || isAdmin() || isOwner(resource.data.authorUid);
      
      allow create: if request.auth != null;

      allow update: if (
        // Any authenticated user can vote or update comment count on an approved post
        request.auth != null && resource.data.status == 'approved' &&
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['upvotes', 'downvotes', 'commentCount'])
      ) || (
        // Admins can manage posts (approve/reject/edit images)
        isAdmin() && hasPermission('approve_pictures') &&
        request.resource.data.diff(resource.data).hasAny(['status', 'images', 'hasPendingImages', 'updatedAt'])
      ) || (
        // The author can edit their own post content
        isOwner(resource.data.authorUid) &&
        request.resource.data.diff(resource.data).subsetOf(['title', 'content', 'category', 'eventDate', 'customFields', 'images', 'hasPendingImages', 'updatedAt', 'isFlagged'])
      )
      || isSuperAdmin();

      allow delete: if isOwner(resource.data.authorUid) || isSuperAdmin() || (isAdmin() && hasPermission('delete_posts'));
    }
    
    match /votes/{voteId} {
      allow get: if isOwner(resource.data.userId);
      allow list: if request.auth.uid != null;
      allow create: if isOwner(request.resource.data.userId);
      allow update, delete: if isOwner(resource.data.userId);
    }

    match /comments/{commentId} {
      allow read: if true;
      allow create: if request.auth != null 
                    && request.resource.data.content != null 
                    && request.resource.data.content.size() > 0
                    && request.resource.data.content.size() < 500;
      allow delete: if isOwner(resource.data.userId) || isSuperAdmin() || (isAdmin() && hasPermission('delete_comments'));
    }

    match /settings/{document} {
      // Any authenticated user can READ settings (required for client-side checks)
      allow read: if request.auth != null;
      // Only specific admins can WRITE settings
      allow write: if isSuperAdmin() || (isAdmin() && (
        (document == 'config' && hasPermission('manage_forbidden_words')) ||
        (document == 'protectedNames' && hasPermission('manage_protected_names')) ||
        (document == 'forbiddenNames' && hasPermission('manage_forbidden_names'))
      ));
    }
  }
}
